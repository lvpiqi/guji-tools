<script setup lang="ts">
/**
 * çº¯æ–‡æœ¬å¯¼å‡º
 * SEO ä¼˜åŒ–ç‰ˆæœ¬
 */
import { ref, computed } from 'vue'
import ToolPageSeo, { type ToolSeoConfig } from '@/components/common/ToolPageSeo.vue'
import ToolFeedback from '@/components/common/ToolFeedback.vue'
import { useQuota } from '@core/composables/useQuota'

// SEO é…ç½®
const seoConfig: ToolSeoConfig = {
  name: 'çº¯æ–‡æœ¬å¯¼å‡º',
  path: '/export/plain-text',
  category: 'å¯¼å‡ºåˆ†äº«',
  categoryPath: '/export',
  
  description: 'å…è´¹åœ¨çº¿å¤ç±çº¯æ–‡æœ¬å¯¼å‡ºå·¥å…·ã€‚å°†å¤ç±å†…å®¹å¯¼å‡ºä¸ºTXT/Markdownæ ¼å¼ï¼Œæ”¯æŒæ ‡ç‚¹è½¬æ¢ã€æ¢è¡Œå¤„ç†å’Œè¡Œå·æ·»åŠ ã€‚',
  keywords: ['çº¯æ–‡æœ¬å¯¼å‡º', 'TXTå¯¼å‡º', 'Markdownå¯¼å‡º', 'å¤ç±æ–‡æœ¬', 'æ ‡ç‚¹è½¬æ¢', 'æ–‡æœ¬æ ¼å¼åŒ–'],
  ogImage: '/og-images/default.png',
  
  publishedTime: '2024-01-01T00:00:00Z',
  modifiedTime: new Date().toISOString(),
  
  shortDesc: 'å°†å¤ç±å†…å®¹å¯¼å‡ºä¸ºTXT/Markdownæ ¼å¼',
  
  features: [
    'æ”¯æŒTXTå’ŒMarkdownæ ¼å¼',
    'å¤ç±æ ‡ç‚¹è½¬ç°ä»£æ ‡ç‚¹',
    'å¯é€‰ç§»é™¤æ‰€æœ‰æ ‡ç‚¹',
    'æŒ‰æ®µè½æˆ–å¥å­æ¢è¡Œ',
    'å¯æ·»åŠ æ–‡æ¡£æ ‡é¢˜',
    'å¯æ·»åŠ è¡Œå·',
    'å®æ—¶é¢„è§ˆå¯¼å‡ºæ•ˆæœ',
    'æ”¯æŒå¤åˆ¶åˆ°å‰ªè´´æ¿'
  ],
  
  howToUse: [
    'ç²˜è´´æˆ–è¾“å…¥å¤ç±æ–‡æœ¬å†…å®¹',
    'é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼ˆTXT/Markdownï¼‰',
    'è®¾ç½®æ ‡ç‚¹å’Œæ¢è¡Œå¤„ç†æ–¹å¼',
    'é¢„è§ˆå¯¼å‡ºæ•ˆæœ',
    'ä¸‹è½½æ–‡ä»¶æˆ–å¤åˆ¶åˆ°å‰ªè´´æ¿'
  ],
  
  introduction: `å¤ç±æ–‡æœ¬åœ¨ä¸åŒåœºæ™¯ä¸‹éœ€è¦ä¸åŒçš„æ ¼å¼ã€‚æœ¬å·¥å…·å¯ä»¥å°†å¤ç±å†…å®¹è½¬æ¢ä¸ºçº¯æ–‡æœ¬æˆ–Markdownæ ¼å¼ï¼Œæ–¹ä¾¿åœ¨å„ç§ç¼–è¾‘å™¨å’Œå¹³å°ä¸­ä½¿ç”¨ã€‚

æ ‡ç‚¹è½¬æ¢åŠŸèƒ½å¯ä»¥å°†å¤ç±ä¸“ç”¨æ ‡ç‚¹ï¼ˆå¦‚ã€Œã€ã€ã€ï¼‰è½¬æ¢ä¸ºç°ä»£æ ‡ç‚¹ï¼ˆå¦‚""''ï¼‰ï¼Œæé«˜å…¼å®¹æ€§ã€‚æ¢è¡Œå¤„ç†å¯ä»¥æŒ‰æ®µè½æˆ–å¥å­åˆ†è¡Œï¼Œä¾¿äºé˜…è¯»å’Œç¼–è¾‘ã€‚

Markdownæ ¼å¼é€‚åˆåœ¨GitHubã€Notionç­‰å¹³å°ä½¿ç”¨ï¼Œæ”¯æŒæ ‡é¢˜ç­‰åŸºæœ¬æ ¼å¼ã€‚`,

  faq: [
    {
      question: 'TXTå’ŒMarkdownæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ',
      answer: 'TXTæ˜¯çº¯æ–‡æœ¬ï¼ŒMarkdownæ”¯æŒæ ‡é¢˜ã€åˆ—è¡¨ç­‰ç®€å•æ ¼å¼ï¼Œåœ¨æ”¯æŒçš„å¹³å°ä¸Šæ˜¾ç¤ºæ›´ç¾è§‚ã€‚'
    },
    {
      question: 'æ ‡ç‚¹è½¬æ¢ä¼šæ”¹å˜å“ªäº›ç¬¦å·ï¼Ÿ',
      answer: 'ä¸»è¦å°†ã€Œã€è½¬ä¸º\u201C\u201Dï¼Œã€ã€è½¬ä¸º\u2018\u2019ç­‰å¤ç±ä¸“ç”¨æ ‡ç‚¹è½¬ä¸ºç°ä»£æ ‡ç‚¹ã€‚'
    },
    {
      question: 'è¡Œå·æœ‰ä»€ä¹ˆç”¨ï¼Ÿ',
      answer: 'è¡Œå·ä¾¿äºå¼•ç”¨å’Œè®¨è®ºç‰¹å®šå†…å®¹ï¼Œå¸¸ç”¨äºå­¦æœ¯ç ”ç©¶ã€‚'
    },
    {
      question: 'å¯ä»¥å¤„ç†å¤šé•¿çš„æ–‡æœ¬ï¼Ÿ',
      answer: 'ç†è®ºä¸Šæ²¡æœ‰é™åˆ¶ï¼Œä½†è¿‡é•¿çš„æ–‡æœ¬å¯èƒ½å¯¼è‡´æµè§ˆå™¨å˜æ…¢ã€‚å»ºè®®å•æ¬¡ä¸è¶…è¿‡10ä¸‡å­—ã€‚'
    }
  ],
  
  supportedFormats: ['TXT', 'MD'],
  isOffline: true,
  isFree: true
}

// é…é¢æ£€æŸ¥
const { canPerform, consume } = useQuota('plain-text-export', 'çº¯æ–‡æœ¬å¯¼å‡º')

const inputText = ref('')
const processing = ref(false)

// å¯¼å‡ºé€‰é¡¹
const options = ref({
  format: 'txt' as 'txt' | 'md',
  punctuation: 'keep' as 'keep' | 'modern' | 'remove',
  lineBreak: 'paragraph' as 'paragraph' | 'sentence' | 'none',
  addTitle: true,
  title: '',
  addLineNumbers: false,
})

// å¤ç±æ ‡ç‚¹è½¬ç°ä»£æ ‡ç‚¹
const punctuationMap: Record<string, string> = {
  "\u300C": "\u201C", // ã€Œ -> "
  "\u300D": "\u201D", // ã€ -> "
  "\u300E": "\u2018", // ã€ -> '
  "\u300F": "\u2019", // ã€ -> '
}

function processText(text: string): string {
  let result = text.trim()
  
  // æ ‡ç‚¹å¤„ç†
  if (options.value.punctuation === 'modern') {
    for (const [old, modern] of Object.entries(punctuationMap)) {
      result = result.replace(new RegExp(old, 'g'), modern)
    }
  } else if (options.value.punctuation === 'remove') {
    result = result.replace(/[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€""''ï¼ˆï¼‰ã€Šã€‹ã€ã€‘ã€Œã€ã€ã€]/g, '')
  }
  
  // æ¢è¡Œå¤„ç†
  if (options.value.lineBreak === 'sentence') {
    result = result.replace(/([ã€‚ï¼ï¼Ÿ])/g, '$1\n')
  } else if (options.value.lineBreak === 'none') {
    result = result.replace(/\n+/g, '')
  }
  
  // æ·»åŠ è¡Œå·
  if (options.value.addLineNumbers) {
    const lines = result.split('\n')
    result = lines.map((line, i) => `${String(i + 1).padStart(4, ' ')}  ${line}`).join('\n')
  }
  
  // æ·»åŠ æ ‡é¢˜
  if (options.value.addTitle && options.value.title) {
    if (options.value.format === 'md') {
      result = `# ${options.value.title}\n\n${result}`
    } else {
      result = `${options.value.title}\n${'='.repeat(options.value.title.length * 2)}\n\n${result}`
    }
  }
  
  return result
}

const previewText = computed(() => {
  if (!inputText.value) return ''
  const processed = processText(inputText.value)
  return processed.length > 500 ? processed.slice(0, 500) + '...' : processed
})

const charCount = computed(() => {
  const text = inputText.value.replace(/\s/g, '')
  return text.length
})

function downloadFile() {
  if (!inputText.value.trim()) return
  
  const check = canPerform()
  if (!check.allowed) {
    alert(check.reason || 'ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™')
    return
  }
  
  processing.value = true
  consume(1)
  
  setTimeout(() => {
    const content = processText(inputText.value)
    const ext = options.value.format
    const filename = `${options.value.title || 'å¤ç±æ–‡æœ¬'}.${ext}`
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = filename
    a.click()
    URL.revokeObjectURL(url)
    
    processing.value = false
  }, 200)
}

function copyToClipboard() {
  const content = processText(inputText.value)
  navigator.clipboard.writeText(content)
  alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
}

function clearAll() {
  inputText.value = ''
  options.value.title = ''
}

const exampleText = `å­æ›°ï¼šã€Œå­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ï¼Ÿæœ‰æœ‹è‡ªè¿œæ–¹æ¥ï¼Œä¸äº¦ä¹ä¹ï¼Ÿäººä¸çŸ¥è€Œä¸æ„ ï¼Œä¸äº¦å›å­ä¹ï¼Ÿã€

æœ‰å­æ›°ï¼šã€Œå…¶ä¸ºäººä¹Ÿå­å¼Ÿï¼Œè€Œå¥½çŠ¯ä¸Šè€…ï¼Œé²œçŸ£ï¼›ä¸å¥½çŠ¯ä¸Šï¼Œè€Œå¥½ä½œä¹±è€…ï¼Œæœªä¹‹æœ‰ä¹Ÿã€‚å›å­åŠ¡æœ¬ï¼Œæœ¬ç«‹è€Œé“ç”Ÿã€‚å­å¼Ÿä¹Ÿè€…ï¼Œå…¶ä¸ºä»ä¹‹æœ¬ä¸ï¼ã€

å­æ›°ï¼šã€Œå·§è¨€ä»¤è‰²ï¼Œé²œçŸ£ä»ï¼ã€`

function useExample() {
  inputText.value = exampleText
  options.value.title = 'è®ºè¯­Â·å­¦è€Œç¯‡'
}
</script>

<template>
  <ToolPageSeo :config="seoConfig">
    <div class="tool-body">

    <!-- å¯¼å‡ºé€‰é¡¹ -->
    <div class="options-section">
      <h2>å¯¼å‡ºé€‰é¡¹</h2>
      <div class="options-grid">
        <div class="option-item">
          <label>æ–‡ä»¶æ ¼å¼</label>
          <select v-model="options.format">
            <option value="txt">çº¯æ–‡æœ¬ (.txt)</option>
            <option value="md">Markdown (.md)</option>
          </select>
        </div>
        
        <div class="option-item">
          <label>æ ‡ç‚¹å¤„ç†</label>
          <select v-model="options.punctuation">
            <option value="keep">ä¿æŒåŸæ ·</option>
            <option value="modern">è½¬ç°ä»£æ ‡ç‚¹</option>
            <option value="remove">ç§»é™¤æ ‡ç‚¹</option>
          </select>
        </div>
        
        <div class="option-item">
          <label>æ¢è¡Œæ–¹å¼</label>
          <select v-model="options.lineBreak">
            <option value="paragraph">æŒ‰æ®µè½</option>
            <option value="sentence">æŒ‰å¥å­</option>
            <option value="none">ä¸æ¢è¡Œ</option>
          </select>
        </div>
        
        <div class="option-item">
          <label>æ–‡æ¡£æ ‡é¢˜</label>
          <input v-model="options.title" type="text" placeholder="å¯é€‰" />
        </div>
        
        <div class="option-item checkbox-item">
          <label>
            <input type="checkbox" v-model="options.addTitle" />
            æ·»åŠ æ ‡é¢˜åˆ°æ–‡æ¡£
          </label>
        </div>
        
        <div class="option-item checkbox-item">
          <label>
            <input type="checkbox" v-model="options.addLineNumbers" />
            æ·»åŠ è¡Œå·
          </label>
        </div>
      </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-section">
      <div class="input-header">
        <h2>è¾“å…¥æ–‡æœ¬</h2>
        <span class="char-count">{{ charCount }} å­—</span>
      </div>
      <textarea
        v-model="inputText"
        placeholder="è¯·ç²˜è´´æˆ–è¾“å…¥å¤ç±æ–‡æœ¬..."
        rows="8"
      ></textarea>
      <button class="example-btn" @click="useExample">ä½¿ç”¨ç¤ºä¾‹æ–‡æœ¬</button>
    </div>

    <!-- é¢„è§ˆåŒºåŸŸ -->
    <div v-if="inputText" class="preview-section">
      <h2>å¯¼å‡ºé¢„è§ˆ</h2>
      <pre class="preview-content">{{ previewText }}</pre>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="actions-section">
      <button 
        class="download-btn"
        :disabled="processing || !inputText.trim()"
        @click="downloadFile"
      >
        {{ processing ? 'å¤„ç†ä¸­...' : `ğŸ“¥ ä¸‹è½½ .${options.format} æ–‡ä»¶` }}
      </button>
      <button 
        class="copy-btn"
        :disabled="!inputText.trim()"
        @click="copyToClipboard"
      >
        ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿
      </button>
      <button class="clear-btn" @click="clearAll">æ¸…ç©º</button>
      <ToolFeedback tool-name="çº¯æ–‡æœ¬å¯¼å‡º" />
    </div>
    </div>
  </ToolPageSeo>
</template>

<style scoped>
.tool-body { @apply max-w-4xl mx-auto space-y-4; }

.options-section { @apply bg-white rounded-xl p-4; }
.options-section h2 { @apply font-medium text-stone-800 mb-3; }
.options-grid { @apply grid grid-cols-2 md:grid-cols-3 gap-4; }
.option-item { @apply space-y-1; }
.option-item > label { @apply block text-sm text-stone-600; }
.option-item select, .option-item input[type="text"] {
  @apply w-full px-3 py-2 border border-stone-300 rounded-lg text-sm;
}
.checkbox-item label { @apply flex items-center gap-2 text-sm cursor-pointer; }

.input-section { @apply bg-white rounded-xl p-4; }
.input-header { @apply flex justify-between items-center mb-2; }
.input-header h2 { @apply font-medium text-stone-800; }
.char-count { @apply text-sm text-stone-500; }
.input-section textarea {
  @apply w-full p-3 border border-stone-300 rounded-lg resize-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none font-mono text-sm;
}
.example-btn { @apply mt-2 text-sm text-amber-600 hover:underline; }

.preview-section { @apply bg-white rounded-xl p-4; }
.preview-section h2 { @apply font-medium text-stone-800 mb-3; }
.preview-content {
  @apply bg-stone-50 p-4 rounded-lg text-sm font-mono whitespace-pre-wrap max-h-64 overflow-auto;
}

.actions-section { @apply flex flex-wrap gap-3; }
.download-btn {
  @apply flex-1 py-3 bg-amber-500 text-white font-medium rounded-lg hover:bg-amber-600 disabled:opacity-50;
}
.copy-btn {
  @apply px-6 py-3 border border-stone-300 rounded-lg hover:bg-stone-50;
}
.clear-btn {
  @apply px-6 py-3 border border-stone-300 rounded-lg hover:bg-stone-50 text-red-500;
}
</style>
