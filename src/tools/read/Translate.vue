<script setup lang="ts">
/**
 * è‡ªåŠ¨ç¿»è¯‘å·¥å…·
 * SEO ä¼˜åŒ–ç‰ˆæœ¬
 */
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import ToolPageSeo, { type ToolSeoConfig } from '@/components/common/ToolPageSeo.vue'
import ToolFeedback from '@/components/common/ToolFeedback.vue'
import { useQuota } from '@core/composables/useQuota'

// é…é¢æ£€æŸ¥
const { canPerform, consume } = useQuota('translate', 'å¤æ–‡ç¿»è¯‘')

// SEO é…ç½®
const seoConfig: ToolSeoConfig = {
  name: 'å¤æ–‡ç¿»è¯‘',
  path: '/read/translate',
  category: 'é˜…è¯»è¾…åŠ©',
  categoryPath: '/read',
  
  description: 'å…è´¹åœ¨çº¿å¤æ–‡ç¿»è¯‘å·¥å…·ã€‚ä½¿ç”¨AIå°†æ–‡è¨€æ–‡ç¿»è¯‘ä¸ºç°ä»£æ±‰è¯­å’Œè‹±æ–‡ï¼Œæ”¯æŒç›´è¯‘å’Œæ„è¯‘ä¸¤ç§é£æ ¼ã€‚',
  keywords: ['å¤æ–‡ç¿»è¯‘', 'æ–‡è¨€æ–‡ç¿»è¯‘', 'å¤æ–‡ç™½è¯', 'å¤ç±ç¿»è¯‘', 'AIç¿»è¯‘', 'ä¸­è‹±ç¿»è¯‘'],
  ogImage: '/og-images/default.png',
  
  publishedTime: '2024-01-01T00:00:00Z',
  modifiedTime: new Date().toISOString(),
  
  shortDesc: 'æ–‡è¨€æ–‡ç¿»è¯‘ä¸ºç°ä»£æ±‰è¯­å’Œè‹±æ–‡',
  
  features: [
    'æ–‡è¨€æ–‡è½¬ç°ä»£æ±‰è¯­',
    'ç°ä»£æ±‰è¯­è½¬è‹±æ–‡',
    'æ”¯æŒç›´è¯‘é£æ ¼',
    'æ”¯æŒæ„è¯‘é£æ ¼',
    'å¯é€‰ç¿»è¯‘ç›®æ ‡è¯­è¨€',
    'ç‚¹å‡»æ±‰å­—æŸ¥çœ‹é‡Šä¹‰',
    'ä¸€é”®å¤åˆ¶ç¿»è¯‘ç»“æœ',
    'ä½¿ç”¨DeepSeek AI'
  ],
  
  howToUse: [
    'é…ç½®DeepSeek API Key',
    'è¾“å…¥è¦ç¿»è¯‘çš„æ–‡è¨€æ–‡',
    'é€‰æ‹©ç¿»è¯‘ç›®æ ‡å’Œé£æ ¼',
    'ç‚¹å‡»ã€Œå¼€å§‹ç¿»è¯‘ã€',
    'æŸ¥çœ‹ç¿»è¯‘ç»“æœï¼Œå¯å¤åˆ¶ä½¿ç”¨'
  ],
  
  introduction: `é˜…è¯»å¤ç±æ—¶ï¼Œå°†æ–‡è¨€æ–‡ç¿»è¯‘ä¸ºç°ä»£æ±‰è¯­å¯ä»¥å¸®åŠ©ç†è§£æ–‡æ„ã€‚æœ¬å·¥å…·ä½¿ç”¨AIè¿›è¡Œç¿»è¯‘ï¼Œæ”¯æŒç¿»è¯‘ä¸ºç°ä»£æ±‰è¯­å’Œè‹±æ–‡ã€‚

ç›´è¯‘é£æ ¼å°½é‡ä¿æŒåŸæ–‡ç»“æ„ï¼Œé€å­—é€å¥ç¿»è¯‘ï¼›æ„è¯‘é£æ ¼åˆ™æ›´æ³¨é‡è¡¨è¾¾åŸæ–‡çš„æ„æ€ï¼Œè¯­è¨€æ›´åŠ æµç•…è‡ªç„¶ã€‚

ç¿»è¯‘ç»“æœä¸­çš„æ±‰å­—å¯ä»¥ç‚¹å‡»æŸ¥çœ‹é‡Šä¹‰ï¼Œæ–¹ä¾¿æ·±å…¥ç†è§£æ¯ä¸ªå­—è¯çš„å«ä¹‰ã€‚`,

  faq: [
    {
      question: 'ç¿»è¯‘å‡†ç¡®å—ï¼Ÿ',
      answer: 'AIç¿»è¯‘ä»…ä¾›å‚è€ƒï¼Œé‡è¦æ–‡çŒ®è¯·ä»¥ä¸“ä¸šè¯‘æœ¬ä¸ºå‡†ã€‚'
    },
    {
      question: 'ç›´è¯‘å’Œæ„è¯‘æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ',
      answer: 'ç›´è¯‘ä¿æŒåŸæ–‡ç»“æ„ï¼Œæ„è¯‘æ›´æ³¨é‡æµç•…è¡¨è¾¾ã€‚å¤æ–‡å»ºè®®å…ˆç”¨ç›´è¯‘ç†è§£ï¼Œå†çœ‹æ„è¯‘ã€‚'
    },
    {
      question: 'API Keyå¦‚ä½•è·å–ï¼Ÿ',
      answer: 'è®¿é—® platform.deepseek.com æ³¨å†Œè´¦å·å³å¯è·å–API Keyã€‚'
    },
    {
      question: 'ç¿»è¯‘æœ‰å­—æ•°é™åˆ¶å—ï¼Ÿ',
      answer: 'å»ºè®®å•æ¬¡ç¿»è¯‘ä¸è¶…è¿‡500å­—ï¼Œè¿‡é•¿çš„æ–‡æœ¬å¯èƒ½å½±å“ç¿»è¯‘è´¨é‡ã€‚'
    },
    {
      question: 'å¯ä»¥ç¿»è¯‘è¯—è¯å—ï¼Ÿ',
      answer: 'å¯ä»¥ï¼Œä½†è¯—è¯çš„éŸµå¾‹å’Œæ„å¢ƒéš¾ä»¥å®Œå…¨ä¼ è¾¾ï¼Œç¿»è¯‘ä»…ä¾›ç†è§£å¤§æ„ã€‚'
    }
  ],
  
  isOffline: false,
  isFree: true
}

const router = useRouter()
const inputText = ref('')
const modernChinese = ref('')
const english = ref('')
const processing = ref(false)
const targetLang = ref<'modern' | 'english' | 'both'>('both')
const style = ref<'literal' | 'free'>('literal')
const apiKey = ref(localStorage.getItem('deepseek_api_key') || '')

async function doTranslate() {
  if (!inputText.value.trim() || !apiKey.value) return
  
  // é…é¢æ£€æŸ¥
  const check = canPerform()
  if (!check.allowed) {
    alert(check.reason || 'ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™')
    return
  }
  
  processing.value = true
  modernChinese.value = ''
  english.value = ''
  
  // æ¶ˆè€—é…é¢
  await consume(1)
  
  try {
    const styleDesc = style.value === 'literal' ? '\u76F4\u8BD1' : '\u610F\u8BD1'
    if (targetLang.value === 'modern' || targetLang.value === 'both') {
      const resp = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey.value}` },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [
            { role: 'system', content: `\u53E4\u6587\u7FFB\u8BD1\u4E13\u5BB6\u3002${styleDesc}\u3002\u53EA\u8F93\u51FA\u8BD1\u6587\u3002` },
            { role: 'user', content: `\u7FFB\u8BD1\u4E3A\u73B0\u4EE3\u6C49\u8BED\uFF1A${inputText.value}` }
          ], temperature: 0.3
        })
      })
      modernChinese.value = (await resp.json()).choices?.[0]?.message?.content || ''
    }
    if (targetLang.value === 'english' || targetLang.value === 'both') {
      const src = modernChinese.value || inputText.value
      const resp = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey.value}` },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [
            { role: 'system', content: 'Translate to English. Output only.' },
            { role: 'user', content: src }
          ], temperature: 0.3
        })
      })
      english.value = (await resp.json()).choices?.[0]?.message?.content || ''
    }
  } catch { alert('\u7FFB\u8BD1\u5931\u8D25') }
  finally { processing.value = false }
}
function saveApiKey() { localStorage.setItem('deepseek_api_key', apiKey.value); doTranslate() }
function goToChar(c: string) { if (/[\u4e00-\u9fff]/.test(c)) router.push(`/char/${encodeURIComponent(c)}`) }
function copy(t: string) { navigator.clipboard.writeText(t); alert('\u5DF2\u590D\u5236') }
function clear() { inputText.value = ''; modernChinese.value = ''; english.value = '' }
const examples = ['\u5B50\u66F0\uFF1A\u5B66\u800C\u65F6\u4E60\u4E4B', '\u9053\u53EF\u9053\uFF0C\u975E\u5E38\u9053']
function useEx(t: string) { inputText.value = t; doTranslate() }
</script>

<template>
  <ToolPageSeo :config="seoConfig">
    <div class="tool-body">
      <div class="settings-section">
        <div class="setting-group">
          <label>ç¿»è¯‘ç›®æ ‡</label>
          <div class="radio-group">
            <label><input type="radio" v-model="targetLang" value="modern" /> ç°ä»£æ±‰è¯­</label>
            <label><input type="radio" v-model="targetLang" value="english" /> è‹±æ–‡</label>
            <label><input type="radio" v-model="targetLang" value="both" /> ä¸¤è€…éƒ½è¦</label>
          </div>
        </div>
        <div class="setting-group">
          <label>ç¿»è¯‘é£æ ¼</label>
          <div class="radio-group">
            <label><input type="radio" v-model="style" value="literal" /> ç›´è¯‘</label>
            <label><input type="radio" v-model="style" value="free" /> æ„è¯‘</label>
          </div>
        </div>
      </div>
      <div v-if="!apiKey" class="api-panel">
        <p>éœ€è¦é…ç½® DeepSeek API Keyï¼š</p>
        <input v-model="apiKey" type="password" placeholder="sk-..." class="api-input" />
        <button @click="saveApiKey" class="btn-primary">ä¿å­˜</button>
      </div>
      <div class="input-section">
        <textarea v-model="inputText" placeholder="è¯·è¾“å…¥æ–‡è¨€æ–‡..." rows="4"></textarea>
        <div class="examples">
          <span>ç¤ºä¾‹ï¼š</span>
          <button v-for="(ex, i) in examples" :key="i" @click="useEx(ex)">{{ ex }}</button>
        </div>
        <div class="input-actions">
          <button @click="doTranslate" :disabled="processing || !inputText.trim() || !apiKey" class="translate-btn">
            {{ processing ? 'ç¿»è¯‘ä¸­...' : 'å¼€å§‹ç¿»è¯‘' }}
          </button>
          <button @click="clear" class="clear-btn">æ¸…ç©º</button>
          <ToolFeedback tool-name="å¤æ–‡ç¿»è¯‘" />
        </div>
      </div>
      <div v-if="modernChinese || english" class="result-section">
        <div v-if="modernChinese" class="result-block">
          <div class="result-header"><h3>ğŸ“– ç°ä»£æ±‰è¯­</h3><button @click="copy(modernChinese)">å¤åˆ¶</button></div>
          <p class="result-text clickable"><span v-for="(c, i) in modernChinese" :key="i" @click="goToChar(c)">{{ c }}</span></p>
        </div>
        <div v-if="english" class="result-block">
          <div class="result-header"><h3>ğŸŒ English</h3><button @click="copy(english)">å¤åˆ¶</button></div>
          <p class="result-text">{{ english }}</p>
        </div>
      </div>
    </div>
  </ToolPageSeo>
</template>

<style scoped>
.tool-body { @apply max-w-4xl mx-auto space-y-4; }
.settings-section { @apply bg-white rounded-xl p-4 flex flex-wrap gap-6; }
.setting-group label:first-child { @apply block text-sm text-stone-600 mb-2; }
.radio-group { @apply flex gap-4; }
.radio-group label { @apply flex items-center gap-1 text-sm cursor-pointer; }
.api-panel { @apply bg-amber-50 border border-amber-200 rounded-lg p-4 text-center; }
.api-input { @apply w-full max-w-md px-4 py-2 border border-stone-300 rounded-lg my-3; }
.btn-primary { @apply px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600; }
.input-section { @apply bg-white rounded-xl p-4; }
.input-section textarea { @apply w-full p-3 border border-stone-300 rounded-lg resize-none outline-none; }
.examples { @apply flex flex-wrap gap-2 mt-3 text-sm; }
.examples span { @apply text-stone-500; }
.examples button { @apply px-2 py-1 bg-stone-100 rounded hover:bg-stone-200; }
.input-actions { @apply flex gap-2 mt-3; }
.translate-btn { @apply flex-1 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 disabled:opacity-50; }
.clear-btn { @apply px-4 py-2 border border-stone-300 rounded-lg hover:bg-stone-50; }
.result-section { @apply space-y-4; }
.result-block { @apply bg-white rounded-xl p-4; }
.result-header { @apply flex justify-between items-center mb-3; }
.result-header h3 { @apply font-medium text-stone-800; }
.result-header button { @apply text-sm text-amber-600 hover:underline; }
.result-text { @apply text-stone-700 leading-relaxed; }
.result-text.clickable span { @apply cursor-pointer hover:bg-amber-50; }
</style>
