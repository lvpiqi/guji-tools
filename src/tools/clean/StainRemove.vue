<script setup lang="ts">
/**
 * æ°´æ¸/é»„æ–‘ä¿®å¤
 * SEO ä¼˜åŒ–ç‰ˆæœ¬
 */
import { ref } from 'vue'
import ToolPageSeo, { type ToolSeoConfig } from '@/components/common/ToolPageSeo.vue'
import ToolFeedback from '@/components/common/ToolFeedback.vue'

// SEO é…ç½®
const seoConfig: ToolSeoConfig = {
  name: 'æ±¡æ¸ä¿®å¤',
  path: '/clean/stain-remove',
  category: 'å›¾åƒæ¸…ç†',
  categoryPath: '/clean',
  
  description: 'å…è´¹åœ¨çº¿å¤ç±æ°´æ¸é»„æ–‘ä¿®å¤å·¥å…·ã€‚è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤å¤ç±å›¾åƒä¸Šçš„æ°´æ¸ã€é»„æ–‘ã€éœ‰æ–‘ç­‰æ±¡æ¸ï¼Œè¿˜åŸæ¸…æ™°é¡µé¢ã€‚',
  keywords: ['æ°´æ¸ä¿®å¤', 'é»„æ–‘å»é™¤', 'æ±¡æ¸æ¸…ç†', 'å¤ç±ä¿®å¤', 'å›¾åƒä¿®å¤', 'éœ‰æ–‘å»é™¤'],
  ogImage: '/og-images/default.png',
  
  publishedTime: '2024-01-01T00:00:00Z',
  modifiedTime: new Date().toISOString(),
  
  shortDesc: 'è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤å¤ç±å›¾åƒä¸Šçš„æ°´æ¸å’Œé»„æ–‘',
  
  features: [
    'è‡ªåŠ¨æ£€æµ‹é»„æ–‘åŒºåŸŸ',
    'è‡ªåŠ¨æ£€æµ‹æ°´æ¸åŒºåŸŸ',
    'å¯è°ƒèŠ‚ä¿®å¤å¼ºåº¦',
    'ä¿æŠ¤æ–‡å­—åŒºåŸŸé€‰é¡¹',
    'å®æ—¶é¢„è§ˆä¿®å¤æ•ˆæœ',
    'æ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼',
    'æœ¬åœ°å¤„ç†ä¿æŠ¤éšç§',
    'ä¸€é”®ä¸‹è½½ä¿®å¤ç»“æœ'
  ],
  
  howToUse: [
    'ä¸Šä¼ æœ‰æ°´æ¸æˆ–é»„æ–‘çš„å¤ç±å›¾ç‰‡',
    'è°ƒæ•´ä¿®å¤å¼ºåº¦ï¼ˆæ¨è50-70%ï¼‰',
    'æ ¹æ®éœ€è¦å¼€å¯ã€Œä¿æŠ¤æ–‡å­—åŒºåŸŸã€',
    'ç‚¹å‡»ã€Œå¼€å§‹ä¿®å¤ã€è¿›è¡Œå¤„ç†',
    'å¯¹æ¯”æ•ˆæœï¼Œæ»¡æ„åä¸‹è½½ç»“æœ'
  ],
  
  introduction: `å¤ç±åœ¨ä¿å­˜è¿‡ç¨‹ä¸­å¸¸ä¼šå‡ºç°æ°´æ¸ã€é»„æ–‘ã€éœ‰æ–‘ç­‰æ±¡æ¸ï¼Œå½±å“é˜…è¯»å’Œæ•°å­—åŒ–æ•ˆæœã€‚æœ¬å·¥å…·å¯ä»¥è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤è¿™äº›æ±¡æ¸åŒºåŸŸã€‚

å·¥å…·é€šè¿‡é¢œè‰²åˆ†æè¯†åˆ«é»„æ–‘ï¼ˆåé»„è‰²åŒºåŸŸï¼‰å’Œæ°´æ¸ï¼ˆç°è¤è‰²ä¸å‡åŒ€åŒºåŸŸï¼‰ï¼Œç„¶åå°†è¿™äº›åŒºåŸŸçš„é¢œè‰²å‘ç™½è‰²æ–¹å‘è°ƒæ•´ï¼Œè¾¾åˆ°ä¿®å¤æ•ˆæœã€‚

ã€Œä¿æŠ¤æ–‡å­—åŒºåŸŸã€é€‰é¡¹å¯ä»¥é¿å…ä¿®å¤è¿‡ç¨‹å½±å“åˆ°æ–‡å­—çš„æ¸…æ™°åº¦ã€‚å»ºè®®å…ˆç”¨è¾ƒä½å¼ºåº¦å°è¯•ï¼Œé€æ­¥è°ƒæ•´åˆ°æ»¡æ„æ•ˆæœã€‚`,

  faq: [
    {
      question: 'ä¿®å¤å¼ºåº¦è®¾å¤šå°‘åˆé€‚ï¼Ÿ',
      answer: 'é€šå¸¸50-70%æ•ˆæœè¾ƒå¥½ã€‚å¼ºåº¦å¤ªé«˜å¯èƒ½å¯¼è‡´èƒŒæ™¯è¿‡ç™½ï¼Œå¤ªä½åˆ™ä¿®å¤ä¸æ˜æ˜¾ã€‚'
    },
    {
      question: 'ã€Œä¿æŠ¤æ–‡å­—åŒºåŸŸã€æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ',
      answer: 'å¼€å¯åä¼šå°½é‡ä¿æŒæ·±è‰²åŒºåŸŸï¼ˆæ–‡å­—ï¼‰ä¸å˜ï¼Œåªä¿®å¤æµ…è‰²æ±¡æ¸åŒºåŸŸã€‚'
    },
    {
      question: 'èƒ½ä¿®å¤æ‰€æœ‰ç±»å‹çš„æ±¡æ¸å—ï¼Ÿ',
      answer: 'ä¸»è¦é’ˆå¯¹é»„æ–‘å’Œæ°´æ¸ã€‚å¢¨æ¸ã€æ²¹æ¸ç­‰æ·±è‰²æ±¡æ¸æ•ˆæœæœ‰é™ã€‚'
    },
    {
      question: 'ä¿®å¤åæ–‡å­—ä¼šå˜æ·¡å—ï¼Ÿ',
      answer: 'å¼€å¯ã€Œä¿æŠ¤æ–‡å­—åŒºåŸŸã€å¯ä»¥æœ€å¤§ç¨‹åº¦ä¿æŠ¤æ–‡å­—ã€‚å¦‚æœæ–‡å­—å˜æ·¡ï¼Œå¯ä»¥é™ä½ä¿®å¤å¼ºåº¦ã€‚'
    },
    {
      question: 'å¤„ç†é€Ÿåº¦å¦‚ä½•ï¼Ÿ',
      answer: 'å–å†³äºå›¾ç‰‡å¤§å°ã€‚2000x3000çš„å›¾ç‰‡é€šå¸¸åœ¨2-5ç§’å†…å®Œæˆã€‚'
    }
  ],
  
  supportedFormats: ['JPG', 'PNG', 'WebP'],
  maxFileSize: 20,
  isOffline: true,
  isFree: true
}

const imageFile = ref<File | null>(null)
const imageUrl = ref('')
const resultUrl = ref('')
const processing = ref(false)
const strength = ref(50)
const preserveText = ref(true)

function handleDrop(e: DragEvent) {
  e.preventDefault()
  const file = e.dataTransfer?.files[0]
  if (file?.type.startsWith('image/')) loadImage(file)
}

function handleFileSelect(e: Event) {
  const file = (e.target as HTMLInputElement).files?.[0]
  if (file) loadImage(file)
}

function loadImage(file: File) {
  imageFile.value = file
  imageUrl.value = URL.createObjectURL(file)
  resultUrl.value = ''
}

async function processImage() {
  if (!imageFile.value) return
  processing.value = true
  try {
    const img = new Image()
    img.src = imageUrl.value
    await new Promise(r => img.onload = r)
    const canvas = document.createElement('canvas')
    canvas.width = img.width
    canvas.height = img.height
    const ctx = canvas.getContext('2d')!
    ctx.drawImage(img, 0, 0)
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
    const data = imageData.data
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i], g = data[i + 1], b = data[i + 2]
      const isYellow = r > 180 && g > 160 && b < 150 && (r - b) > 40
      const isWater = r > 150 && g > 140 && b > 120 && Math.abs(r - g) < 30 && (r + g + b) / 3 < 200
      if (isYellow || isWater) {
        const factor = strength.value / 100
        const avg = (r + g + b) / 3
        const target = preserveText.value ? Math.max(avg, 240) : 250
        data[i] = Math.round(r + (target - r) * factor)
        data[i + 1] = Math.round(g + (target - g) * factor)
        data[i + 2] = Math.round(b + (target - b) * factor)
      }
    }
    ctx.putImageData(imageData, 0, 0)
    resultUrl.value = canvas.toDataURL('image/png')
  } finally { processing.value = false }
}

function download() {
  if (!resultUrl.value) return
  const a = document.createElement('a')
  a.href = resultUrl.value
  a.download = `stain_removed_${imageFile.value?.name || 'image.png'}`
  a.click()
}

function clearAll() {
  imageFile.value = null
  imageUrl.value = ''
  resultUrl.value = ''
}
</script>

<template>
  <ToolPageSeo :config="seoConfig">
    <div class="tool-body">
      <div class="settings-section">
        <div class="setting-group">
          <label>ä¿®å¤å¼ºåº¦: {{ strength }}%</label>
          <input type="range" v-model="strength" min="10" max="100" class="slider" />
        </div>
        <div class="setting-group">
          <label class="checkbox"><input type="checkbox" v-model="preserveText" /> ä¿æŠ¤æ–‡å­—åŒºåŸŸ</label>
        </div>
      </div>
      <div v-if="!imageUrl" class="upload-zone" @drop="handleDrop" @dragover.prevent @click="($refs.fileInput as HTMLInputElement).click()">
        <input ref="fileInput" type="file" accept="image/*" hidden @change="handleFileSelect" />
        <p class="upload-text">ğŸ“ æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
      </div>
      <div v-else class="preview-section">
        <div class="preview-grid">
          <div class="preview-item"><h3>åŸå›¾</h3><img :src="imageUrl" alt="åŸå›¾" /></div>
          <div class="preview-item">
            <h3>ä¿®å¤å</h3>
            <img v-if="resultUrl" :src="resultUrl" alt="ä¿®å¤å" />
            <div v-else class="placeholder">ç‚¹å‡»"å¼€å§‹ä¿®å¤"</div>
          </div>
        </div>
        <div class="actions">
          <button @click="processImage" :disabled="processing" class="process-btn">{{ processing ? 'å¤„ç†ä¸­...' : 'å¼€å§‹ä¿®å¤' }}</button>
          <button v-if="resultUrl" @click="download" class="download-btn">ä¸‹è½½ç»“æœ</button>
          <button @click="clearAll" class="clear-btn">é‡æ–°é€‰æ‹©</button>
          <ToolFeedback tool-name="æ±¡æ¸ä¿®å¤" />
        </div>
      </div>
    </div>
  </ToolPageSeo>
</template>

<style scoped>
.tool-body { @apply max-w-4xl mx-auto space-y-4; }
.settings-section { @apply bg-white rounded-xl p-4 flex flex-wrap gap-6; }
.setting-group { @apply flex flex-col gap-1; }
.setting-group label { @apply text-sm text-stone-600; }
.slider { @apply w-48; }
.checkbox { @apply flex items-center gap-2 cursor-pointer; }
.upload-zone { @apply bg-white border-2 border-dashed border-stone-300 rounded-xl p-12 text-center cursor-pointer hover:border-amber-400; }
.upload-text { @apply text-stone-600; }
.preview-section { @apply bg-white rounded-xl p-4; }
.preview-grid { @apply grid md:grid-cols-2 gap-4 mb-4; }
.preview-item h3 { @apply text-sm font-medium text-stone-600 mb-2; }
.preview-item img { @apply w-full rounded-lg border border-stone-200; }
.placeholder { @apply aspect-video bg-stone-100 rounded-lg flex items-center justify-center text-stone-400; }
.actions { @apply flex gap-3; }
.process-btn { @apply px-6 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 disabled:opacity-50; }
.download-btn { @apply px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600; }
.clear-btn { @apply px-4 py-2 border border-stone-300 rounded-lg hover:bg-stone-50; }
</style>
